import { ImageResponse } from "next/og"
import type { NextRequest } from "next/server"

import { DEPLOYMENT_URL } from "@/lib/config"
import { getPublishedChat } from "@/lib/data/kv"

export const runtime = "edge"

const web3GPTLogoUrl = `${DEPLOYMENT_URL}/assets/web3gpt.png`

export async function GET(req: NextRequest) {
  const chatId = req.nextUrl.searchParams.get("id")
  const height = req.nextUrl.searchParams.get("h")

  if (!chatId) {
    throw new Error("Chat ID is required")
  }

  const chat = await getPublishedChat(chatId)

  return new ImageResponse(
    <div tw="flex w-full items-center h-full flex-col bg-[#000000] text-white p-[80px]">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        role="img"
        aria-label="Web3GPT beta"
        width="362"
        height="59"
        viewBox="0 0 362 59"
        fill="none"
      >
        <path
          d="m124.608 27.128 5.856 13.392-.864.096 5.472-13.488h4.368L130.32 48.2l-6.384-13.632-5.808 13.632-9.216-21.072h4.368l6.192 14.016-1.536-.288 4.416-10.272-1.584-3.456zm36.712-11.712L152.872 29l-2.784-1.296a4.8 4.8 0 0 1 1.392-.48 8.3 8.3 0 0 1 1.536-.144 10.4 10.4 0 0 1 3.456.384 8.3 8.3 0 0 1 3.024 1.584q1.344 1.104 2.112 2.928.816 1.824.816 4.512 0 3.36-1.536 5.808a10.56 10.56 0 0 1-4.08 3.792q-2.496 1.296-5.568 1.296-2.304 0-4.608-.912-2.256-.96-3.744-2.496l2.352-3.84q.912 1.056 2.496 1.92 1.632.864 3.36.864 1.824 0 3.264-.816a6.03 6.03 0 0 0 2.352-2.304q.912-1.536.912-3.552 0-2.784-1.632-4.368-1.584-1.584-4.368-1.584-1.392 0-2.352.24-.96.192-1.728.48l-.144-.192 7.44-11.568 1.44.624h-11.568v-4.464zm17.589 41.424q-2.208 0-3.888-.528a11.2 11.2 0 0 1-3.072-1.392 22 22 0 0 1-2.592-2.064l2.592-3.024q1.584 1.488 3.216 2.304t3.648.816q2.256 0 3.792-.768 1.584-.72 2.4-2.064.816-1.296.816-3.024l.048-5.376.384.864q-.864 2.064-3.12 3.504-2.256 1.392-5.472 1.392a9.57 9.57 0 0 1-5.04-1.392q-2.256-1.392-3.648-3.744-1.344-2.4-1.344-5.376 0-3.12 1.44-5.472 1.44-2.4 3.792-3.792t5.136-1.392q2.64 0 4.8 1.104 2.208 1.056 3.216 2.736l-.24.816.48-3.84h4.08v20.016q0 2.688-1.392 4.896t-3.936 3.504-6.096 1.296m-6.816-19.968q0 1.92.912 3.504a6.8 6.8 0 0 0 2.448 2.496q1.584.912 3.504.912 1.776 0 3.168-.624 1.44-.672 2.4-1.776a6.7 6.7 0 0 0 1.344-2.64v-3.936a6.1 6.1 0 0 0-1.44-2.496 6.7 6.7 0 0 0-2.4-1.68q-1.392-.624-3.072-.624-1.92 0-3.504.864-1.536.864-2.448 2.448-.912 1.536-.912 3.552m37.663 10.608q-2.256 0-4.368-1.056-2.064-1.056-3.216-2.832l.288-1.392v14.352h-4.416V26.84h3.84l.624 5.088-.48-1.392q1.44-1.824 3.648-3.024t4.944-1.2q2.784 0 4.992 1.344 2.256 1.344 3.552 3.744t1.296 5.616-1.392 5.568a9.6 9.6 0 0 1-3.84 3.648q-2.4 1.248-5.472 1.248m-.864-3.552q1.92 0 3.504-.864a7.06 7.06 0 0 0 2.592-2.448q.96-1.584.96-3.552 0-2.016-.912-3.552a6.8 6.8 0 0 0-2.448-2.496q-1.488-.912-3.36-.912-1.728 0-3.12.672a6.3 6.3 0 0 0-2.304 1.872q-.912 1.152-1.296 2.688v3.312a6 6 0 0 0 1.152 2.736q.912 1.2 2.256 1.872 1.392.672 2.976.672m19.525-25.536h4.464v8.832h5.472v3.504h-5.472V47h-4.464V30.728h-3.648v-3.504h3.648zm13.074 26.064q0-1.056.768-1.776.816-.768 1.776-.768.864 0 1.632.768.816.72.816 1.776 0 1.152-.816 1.872-.768.672-1.632.672-.96 0-1.776-.672-.768-.72-.768-1.872m18.575 3.024q-2.784 0-5.088-1.2-2.256-1.2-3.6-3.504-1.296-2.352-1.296-5.712 0-3.312 1.392-5.712 1.392-2.448 3.696-3.744 2.352-1.296 5.136-1.296t4.704 1.296q1.92 1.248 2.928 2.976l-.288.768.432-4.224h4.128V47h-4.464v-5.184l.48 1.152q-.192.48-.864 1.248-.624.72-1.728 1.488-1.056.768-2.448 1.296-1.392.48-3.12.48m1.2-3.696q1.68 0 3.024-.624a5.9 5.9 0 0 0 2.208-1.728q.912-1.152 1.248-2.736v-3.888a5.9 5.9 0 0 0-1.344-2.496 6.3 6.3 0 0 0-2.304-1.68q-1.344-.624-2.976-.624a6.4 6.4 0 0 0-3.264.864 6.64 6.64 0 0 0-2.4 2.4q-.864 1.536-.864 3.6 0 1.92.912 3.504a6.8 6.8 0 0 0 2.448 2.496 6.4 6.4 0 0 0 3.312.912m18.669-16.656h4.464V47h-4.464zm-.336-7.2q0-1.056.816-1.776.864-.72 1.872-.72t1.776.72q.816.72.816 1.776 0 1.104-.816 1.824a2.62 2.62 0 0 1-1.776.672q-1.008 0-1.872-.72-.816-.72-.816-1.776m13.483 23.184h19.44V47h-19.44zm31.911-25.902q-1.197 0-2.121-.525a4.4 4.4 0 0 1-1.449-1.323l.231-.609V17h-1.953V.746h1.932v9.555l-.063-.735q.525-.714 1.491-1.155.987-.462 2.184-.462 1.176 0 2.142.567t1.533 1.596q.588 1.008.588 2.415 0 1.47-.63 2.52a4.23 4.23 0 0 1-1.638 1.617 4.7 4.7 0 0 1-2.247.546m-.399-1.659q.84 0 1.512-.399a2.86 2.86 0 0 0 1.05-1.071q.378-.693.378-1.575 0-.84-.399-1.512a2.8 2.8 0 0 0-1.05-1.092 2.8 2.8 0 0 0-1.491-.399q-.714 0-1.323.273a2.9 2.9 0 0 0-1.029.756q-.42.462-.588 1.092v1.743q.168.63.567 1.134.399.483 1.008.777.609.273 1.365.273m11.587 1.659q-1.491 0-2.562-.588a4.34 4.34 0 0 1-1.659-1.638q-.567-1.05-.567-2.394 0-1.281.651-2.331a4.9 4.9 0 0 1 1.743-1.68q1.092-.63 2.436-.63 1.722 0 2.856 1.008t1.533 2.772l-7.161 2.52-.462-1.155 5.88-2.142-.42.273a2.84 2.84 0 0 0-.84-1.197q-.588-.525-1.533-.525-.798 0-1.428.399-.63.378-.987 1.05t-.357 1.533q0 .903.378 1.596.378.672 1.029 1.071a3.03 3.03 0 0 0 1.512.378q.567 0 1.092-.21.546-.21 1.008-.546l.903 1.449a6 6 0 0 1-1.47.714 4.9 4.9 0 0 1-1.575.273m7.718-12.726h1.953v3.864h2.394v1.533h-2.394V17h-1.953V9.881h-1.596V8.348h1.596zm10.319 12.726a4.75 4.75 0 0 1-2.226-.525 3.95 3.95 0 0 1-1.575-1.533q-.567-1.029-.567-2.499 0-1.449.609-2.499.609-1.071 1.617-1.638a4.6 4.6 0 0 1 2.247-.567q1.218 0 2.058.567.84.546 1.281 1.302l-.126.336.189-1.848h1.806V17h-1.953v-2.268l.21.504q-.084.21-.378.546-.273.315-.756.651a4.6 4.6 0 0 1-1.071.567 4.2 4.2 0 0 1-1.365.21m.525-1.617q.735 0 1.323-.273t.966-.756a2.85 2.85 0 0 0 .546-1.197v-1.701a2.6 2.6 0 0 0-.588-1.092 2.76 2.76 0 0 0-1.008-.735 3.05 3.05 0 0 0-1.302-.273q-.777 0-1.428.378a2.9 2.9 0 0 0-1.05 1.05q-.378.672-.378 1.575a3.02 3.02 0 0 0 1.47 2.625 2.8 2.8 0 0 0 1.449.399M0 15h36v8H0zm36 16h32v8H36zM20 47h32v8H20zm28-32h36v8H48z"
          fill="#21DA03"
        />
      </svg>

      <div tw="flex flex-col w-full pt-[80px]">
        <div tw="flex w-full items-center">
          <div tw="flex h-[80px] w-[80px] items-center justify-center rounded-md border border-[#9b9ba4]">
            {chat?.avatarUrl ? (
              // biome-ignore lint/performance/noImgElement: og generation
              <img
                src={chat.avatarUrl}
                alt={chat.title}
                tw="w-full h-full object-cover rounded-md"
                height={48}
                width={48}
              />
            ) : (
              <svg
                role="img"
                aria-label="Chat"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 256 256"
                fill="currentColor"
                width={48}
                height={48}
              >
                <path d="M230.92 212c-15.23-26.33-38.7-45.21-66.09-54.16a72 72 0 1 0-73.66 0c-27.39 8.94-50.86 27.82-66.09 54.16a8 8 0 1 0 13.85 8c18.84-32.56 52.14-52 89.07-52s70.23 19.44 89.07 52a8 8 0 1 0 13.85-8ZM72 96a56 56 0 1 1 56 56 56.06 56.06 0 0 1-56-56Z" />
              </svg>
            )}
          </div>
          <div tw="flex text-white font-bold text-4xl leading-normal ml-10">
            {chat?.title || "Create an NFT contract with staking and royalties"}
          </div>
        </div>
        <div tw="flex w-full mt-14 items-start">
          <div tw="flex h-[80px] w-[80px] items-center justify-center rounded-md border border-[#9b9ba4]">
            {/** biome-ignore lint/performance/noImgElement: og generation */}
            <img src={web3GPTLogoUrl} alt={"Web3GPT assistant logo"} tw="w-full h-full object-cover rounded-md" />
          </div>
          <div tw="flex text-white font-bold text-6xl leading-none ml-10">...</div>
        </div>
      </div>
      <div tw="flex items-center justify-between w-full mt-auto">
        <div tw="text-[1.8rem] ml-auto text-[#9b9ba4]">Web3GPT</div>
      </div>
    </div>,
    {
      width: 1200,
      height: height ? Number.parseInt(height) : 630,
    },
  )
}
